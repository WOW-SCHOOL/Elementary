<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WOW SCHOOL — English File: Elementary</title>
  <meta name="color-scheme" content="dark light" />

  <!-- ✅ Превью-обложка для Miro / соцсетей -->
  <meta property="og:title" content="WOW SCHOOL — English File: Elementary">
  <meta property="og:type" content="website">
  <meta property="og:image" content="cover.jpg">
  <meta property="og:image:alt" content="English File — Elementary (cover)">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="WOW SCHOOL — English File: Elementary">
  <meta name="twitter:image" content="cover.jpg">
  <link rel="image_src" href="cover.jpg">

  <link rel="stylesheet" href="style.css?v=5" />

  <script>
  // Управление видом в iFrame Miro через параметры URL
  (function () {
    const q = new URLSearchParams(location.search);

    // Включаем «режим Miro» по флагу ?miro=1
    if (q.has('miro')) document.documentElement.classList.add('miro');

    // Масштаб (zoom) страницы, например ?zoom=1.18
    const z = parseFloat(q.get('zoom'));
    if (!Number.isNaN(z)) document.documentElement.style.setProperty('--miro-zoom', z);

    // Дополнительное увеличение шрифтов, например ?fs=1.1 (10% больше)
    const fs = parseFloat(q.get('fs'));
    if (!Number.isNaN(fs)) document.documentElement.style.setProperty('--miro-font-scale', fs);

    // Восстановим сохранённые значения (если пользователь уже двигал ползунки)
    const savedZ = localStorage.getItem('miroZoom');
    const savedFS = localStorage.getItem('miroFontScale');
    if (savedZ && !q.has('zoom')) document.documentElement.style.setProperty('--miro-zoom', savedZ);
    if (savedFS && !q.has('fs'))  document.documentElement.style.setProperty('--miro-font-scale', savedFS);
  })();
  </script>
</head>
<body>
  <!-- Обложка (постер) поверх плеера -->
  <div id="poster" class="poster" role="button" aria-label="Открыть плеер" tabindex="0">
    <img src="cover.jpg" alt="English File — Elementary (cover)" />
    <button class="poster-play" aria-label="Play">
      <svg viewBox="0 0 24 24" width="28" height="28" aria-hidden="true">
        <path d="M8 5v14l11-7z" fill="currentColor"></path>
      </svg>
    </button>
  </div>

  <!-- ✅ Панелька зума (появляется поверх справа-сверху) -->
  <div class="zoom-ui" aria-label="Масштаб">
    <button id="zMinus" title="Уменьшить">–</button>
    <span class="zoom-val" id="zVal">100%</span>
    <button id="zPlus" title="Увеличить">+</button>
    <button id="zReset" title="Сбросить масштаб">100%</button>
  </div>

  <header class="site-head">
    <div class="brand">WOW SCHOOL</div>
    <h1 class="page-title">English File: Elementary</h1>
  </header>

  <main class="player-card" role="region" aria-label="Аудиоплеер">
    <!-- Now playing -->
    <div class="now">
      <div class="np-top">
        <div class="np-title" id="npTitle">—</div>
        <div class="np-time"><span id="cur">0:00</span> / <span id="dur">0:00</span></div>
      </div>

      <!-- progress -->
      <input id="seek" class="seek" type="range" min="0" max="1000" step="1" value="0" aria-label="Позиция трека" />
    </div>

    <!-- track list -->
    <ul id="list" class="tracklist" role="listbox" aria-label="Список треков"></ul>

    <!-- controls (СНИЗУ ПО ЦЕНТРУ) -->
    <div class="controls">
      <button id="prev" class="ctrl ctrl-sm" aria-label="Предыдущий трек" title="Предыдущий">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </button>

      <button id="play" class="ctrl ctrl-lg" aria-label="Воспроизвести/пауза" title="Воспроизвести/пауза">
        <svg class="icon-play" viewBox="0 0 24 24" aria-hidden="true"><path d="M8 5v14l11-7z"/></svg>
        <svg class="icon-pause" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 5h4v14H6zm8 0h4v14h-4z"/></svg>
      </button>

      <button id="next" class="ctrl ctrl-sm" aria-label="Следующий трек" title="Следующий">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="m10 6-1.41 1.41L13.17 12l-4.58 4.59L10 18l6-6z"/></svg>
      </button>
    </div>
  </main>

  <!-- hidden audio element -->
  <audio id="audio" preload="metadata"></audio>

  <script>
  (function () {
    const audio  = document.getElementById('audio');
    const npTitle= document.getElementById('npTitle');
    const cur    = document.getElementById('cur');
    const dur    = document.getElementById('dur');
    const seek   = document.getElementById('seek');
    const listEl = document.getElementById('list');
    const btnPrev= document.getElementById('prev');
    const btnNext= document.getElementById('next');
    const btnPlay= document.getElementById('play');

    let tracks = [];
    let index  = 0;
    let isSeeking = false;

    // формат времени
    function t(s) {
      if (!isFinite(s)) return '0:00';
      const m = Math.floor(s/60);
      const k = Math.floor(s%60).toString().padStart(2,'0');
      return m + ':' + k;
    }

    // подгрузка плейлиста
    fetch('playlist.json?v=4').then(r=>r.json()).then(data=>{
      tracks = data.tracks || [];
      buildList();
      if (tracks.length) loadTrack(0, /*autoplay=*/false);
    }).catch(console.error);

    // построить список
    function buildList() {
      listEl.innerHTML = '';
      tracks.forEach((item, i) => {
        const li = document.createElement('li');
        li.className = 'row';
        li.setAttribute('role','option');
        li.setAttribute('data-i', i);

        const num  = document.createElement('span'); num.className='t-num';   num.textContent = (i+1);
        const name = document.createElement('span'); name.className='t-title'; name.textContent = item.title || ('Track ' + (i+1));
        const len  = document.createElement('span'); len.className='t-len';   len.textContent = item.dur || '';

        li.append(num, name, len);
        li.addEventListener('click', () => loadTrack(i, true));
        listEl.appendChild(li);

        if (!item.dur) {
          const a = new Audio();
          a.src = item.file; a.preload = 'metadata';
          a.addEventListener('loadedmetadata', () => {
            item.dur = t(a.duration);
            len.textContent = item.dur;
          }, {once:true});
        }
      });
    }

    // загрузить трек
    function loadTrack(i, autoplay) {
      index = (i + tracks.length) % tracks.length;
      const tr = tracks[index];
      [...listEl.children].forEach(el => el.classList.remove('active'));
      const active = listEl.querySelector('[data-i="'+index+'"]');
      if (active) active.classList.add('active');

      audio.src = tr.file;
      audio.currentTime = 0;
      npTitle.textContent = tr.title || ('Track ' + (index+1));
      cur.textContent = '0:00';
      dur.textContent = tr.dur || '0:00';
      seek.value = 0;

      if (autoplay) audio.play().catch(()=>{});
      updatePlayBtn();
    }

    // обновление кнопки
    function updatePlayBtn(){
      btnPlay.classList.toggle('is-playing', !audio.paused);
    }

    // события audio
    audio.addEventListener('play',  updatePlayBtn);
    audio.addEventListener('pause', updatePlayBtn);
    audio.addEventListener('loadedmetadata', () => {
      dur.textContent = t(audio.duration);
    });
    audio.addEventListener('timeupdate', () => {
      if (isSeeking) return;
      cur.textContent = t(audio.currentTime);
      if (isFinite(audio.duration) && audio.duration > 0) {
        seek.value = Math.floor(audio.currentTime / audio.duration * 1000);
      }
    });
    audio.addEventListener('ended', () => next());

    // управление
    function playPause(){ audio.paused ? audio.play().catch(()=>{}) : audio.pause(); }
    function prev(){ loadTrack(index-1, true); }
    function next(){ loadTrack(index+1, true); }

    btnPlay.addEventListener('click', playPause);
    btnPrev.addEventListener('click', prev);
    btnNext.addEventListener('click', next);

    // перемотка
    seek.addEventListener('pointerdown', ()=>{ isSeeking = true; });
    seek.addEventListener('pointerup',   ()=>{ isSeeking = false; applySeek(); });
    seek.addEventListener('change',      applySeek);
    function applySeek(){
      if (!isFinite(audio.duration) || audio.duration<=0) return;
      const pos = Number(seek.value)/1000;
      audio.currentTime = pos * audio.duration;
      cur.textContent = t(audio.currentTime);
    }

    // клавиатура
    window.addEventListener('keydown', (e)=>{
      const tag = (e.target.tagName||'').toLowerCase();
      if (tag === 'input' || tag === 'textarea') return;
      if (e.code === 'Space') { e.preventDefault(); playPause(); }
      if (e.code === 'ArrowLeft')  audio.currentTime = Math.max(0, audio.currentTime - 5);
      if (e.code === 'ArrowRight') audio.currentTime = Math.min(audio.duration||0, audio.currentTime + 5);
      if (e.key.toLowerCase() === 'j') audio.currentTime = Math.max(0, audio.currentTime - 10);
      if (e.key.toLowerCase() === 'l') audio.currentTime = Math.min(audio.duration||0, audio.currentTime + 10);
      if (e.key.toLowerCase() === 'k') playPause();
    });
  })();
  </script>

  <!-- Скрытие постера и автозапуск -->
  <script>
  (function () {
    const poster = document.getElementById('poster');
    if (!poster) return;
    const audio = document.querySelector('audio');
    function hidePosterAndPlay() {
      poster.classList.add('hide');
      setTimeout(()=>poster.remove(), 300);
      try { audio && audio.play && audio.play(); } catch(e){}
    }
    poster.addEventListener('click', hidePosterAndPlay);
    poster.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); hidePosterAndPlay(); }
    });
  })();
  </script>

  <!-- ✅ Локальный UI для зума -->
  <script>
  (function(){
    const root = document.documentElement;
    const $    = id => document.getElementById(id);
    const zVal = $('zVal'), zPlus = $('zPlus'), zMinus = $('zMinus'), zReset = $('zReset');

    function get(n, def){ const v = parseFloat(getComputedStyle(root).getPropertyValue(n)); return Number.isFinite(v) ? v : def; }
    function apply(zoom, fs){
      root.style.setProperty('--miro-zoom', zoom);
      root.style.setProperty('--miro-font-scale', fs);
      localStorage.setItem('miroZoom', zoom);
      localStorage.setItem('miroFontScale', fs);
      zVal.textContent = Math.round(zoom*100) + '%';
    }

    function clamp(n,min,max){ return Math.min(max, Math.max(min,n)); }

    function current(){ return { z:get('--miro-zoom',1), fs:get('--miro-font-scale',1) }; }

    zPlus.addEventListener('click', ()=>{
      const {z,fs}=current();
      apply(clamp(z+0.1, 0.6, 2.0), clamp(fs+0.06, 0.8, 1.8));
    });
    zMinus.addEventListener('click', ()=>{
      const {z,fs}=current();
      apply(clamp(z-0.1, 0.6, 2.0), clamp(fs-0.06, 0.8, 1.8));
    });
    zReset.addEventListener('click', ()=>apply(1,1));

    // init label
    zVal.textContent = Math.round(get('--miro-zoom',1)*100) + '%';
  })();
  </script>
</body>
</html>
