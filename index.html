<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WOW SCHOOL — English File: Elementary</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Постер-обложка (видна сразу в Miro) -->
  <div id="poster" class="poster">
    <img src="cover.jpg" alt="English File — Elementary (cover)" />
    <button id="posterPlay" class="poster__play" aria-label="Play">▶</button>
  </div>

  <header class="head">
    <div class="brand">WOW SCHOOL</div>
    <h1 class="title">English File: Elementary</h1>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="now">
        <div class="time">
          <span id="current">0:00</span>
          <span id="total">/ 0:00</span>
        </div>
        <input id="seek" class="seek" type="range" min="0" max="1000" value="0" step="1" />
        <div id="nowTitle" class="track-title">—</div>
      </div>

      <div class="list" id="list" role="listbox" aria-label="Playlist"></div>

      <div class="controls">
        <button id="prev" class="btn" aria-label="Previous">‹</button>
        <button id="play" class="btn btn--play" aria-label="Play/Pause">▶</button>
        <button id="next" class="btn" aria-label="Next">›</button>
      </div>
    </section>
  </main>

  <audio id="audio" preload="metadata"></audio>

  <script>
    // ---------- ЗУМ ИЗ QUERY (?zoom=1.25) ----------
    (function applyZoomFromQuery(){
      const params = new URLSearchParams(location.search);
      const z = parseFloat(params.get('zoom'));
      if (!isNaN(z) && z > 0.5 && z < 3) {
        document.documentElement.style.setProperty('--ui-zoom', z);
      }
    })();

    // ---------- ПРОСТОЙ ПЛЕЕР С ЧТЕНИЕМ playlist.json ----------
    const audio = document.getElementById('audio');
    const listEl = document.getElementById('list');
    const nowTitle = document.getElementById('nowTitle');
    const seek = document.getElementById('seek');
    const cur = document.getElementById('current');
    const tot = document.getElementById('total');
    const btnPlay = document.getElementById('play');
    const btnPrev = document.getElementById('prev');
    const btnNext = document.getElementById('next');

    let tracks = [];
    let index = 0;
    let seekingByScript = false;

    function fmt(t){
      if (!isFinite(t)) return '0:00';
      const m = Math.floor(t/60);
      const s = Math.floor(t%60).toString().padStart(2,'0');
      return `${m}:${s}`;
    }

    async function loadPlaylist(){
      // формát: [{ "title": "...", "file": "tracks/....mp3" }, ...]
      const res = await fetch('playlist.json', { cache:'no-store' });
      tracks = await res.json();
      renderList();
      if (tracks.length) load(index);
    }

    function renderList(){
      listEl.innerHTML = '';
      tracks.forEach((t,i)=>{
        const row = document.createElement('button');
        row.className = 'row';
        row.type = 'button';
        row.setAttribute('role','option');
        row.innerHTML = `<span class="row__num">${i+1}</span><span class="row__title">${t.title || ('Track '+(i+1))}</span>`;
        row.addEventListener('click', ()=>{ index = i; load(index,true); });
        listEl.appendChild(row);
      });
      markActive();
    }

    function markActive(){
      const rows = [...listEl.querySelectorAll('.row')];
      rows.forEach((r,i)=>r.classList.toggle('is-active', i===index));
    }

    function load(i, autoplay=false){
      const t = tracks[i];
      if (!t) return;
      audio.src = t.file || t.path || t.url; // гибко
      nowTitle.textContent = t.title || `Track ${i+1}`;
      markActive();
      if (autoplay) audio.play().catch(()=>{});
    }

    // Прогресс
    audio.addEventListener('loadedmetadata', ()=>{
      tot.textContent = '/ ' + fmt(audio.duration);
    });
    audio.addEventListener('timeupdate', ()=>{
      cur.textContent = fmt(audio.currentTime);
      if (!seekingByScript && isFinite(audio.duration)) {
        seek.value = Math.round(audio.currentTime / audio.duration * 1000);
      }
    });
    seek.addEventListener('input', ()=>{
      if (!isFinite(audio.duration)) return;
      seekingByScript = true;
      audio.currentTime = (seek.value/1000) * audio.duration;
      seekingByScript = false;
    });

    // Контролы
    btnPlay.addEventListener('click', ()=>{
      if (audio.paused) audio.play(); else audio.pause();
    });
    audio.addEventListener('play',  ()=> btnPlay.textContent = '❚❚');
    audio.addEventListener('pause', ()=> btnPlay.textContent = '▶');

    btnPrev.addEventListener('click', ()=>{
      index = (index - 1 + tracks.length) % tracks.length;
      load(index, true);
    });
    btnNext.addEventListener('click', ()=>{
      index = (index + 1) % tracks.length;
      load(index, true);
    });
    audio.addEventListener('ended', ()=>{ btnNext.click(); });

    // ---------- ПОСТЕР/ОБЛОЖКА ----------
    const poster = document.getElementById('poster');
    const posterPlay = document.getElementById('posterPlay');
    function hidePosterAndPlay(){
      poster.classList.add('poster--hide');
      // небольшая задержка, чтобы постер успел скрыться
      setTimeout(()=>{ if (audio.src) audio.play().catch(()=>{}); }, 120);
    }
    poster.addEventListener('click', hidePosterAndPlay);
    posterPlay.addEventListener('click', (e)=>{ e.stopPropagation(); hidePosterAndPlay(); });

    // GO
    loadPlaylist();
  </script>
</body>
</html>
